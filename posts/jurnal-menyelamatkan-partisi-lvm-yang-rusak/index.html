<!doctype html><html lang=id dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa | Linux & Cloud | Blog An-Nahri</title>
<meta name=keywords content="LVM"><meta name=description content="
Pada artikel ini, saya akan menceritakan bagaimana saya berhasil menyelamankan dan mengembalikan paritisi LVM yang hilang metadatanya karena tertimpa oleh metadata SWAP.
Hal ini terjadi diduga karena sang &ldquo;user&rdquo; nampaknya ingin membesar kapasitas RAM dengan menambah ukuran SWAP. Alih-alih membuatnya pada suatu file atau partisi baru, si &ldquo;user&rdquo; tersebut membuatnya di partisi dimana root disk berada.
Sejurus kemudian, muncullah permintaan reboot VM yang dimaksud. Tanpa pikir panjang, rekan saya melakukan reboot. Ditunggu beberapa saat kok tidak kunjung UP, diintiplah via console, dan jeng-jeng-jeng, sistem gagal booting dan fallback ke initramfs dengan pesan error bahwa logical volume untuk root partition tidak ditemukan."><meta name=author content="Muhammad Ahfas An Nahri"><link rel=canonical href=https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/><link crossorigin=anonymous href=/assets/css/stylesheet.13f755722324cf8e264349d656091daf6050df39254ee701eab199fdc10f1c5a.css integrity="sha256-E/dVciMkz44mQ0nWVgkdr2BQ3zklTucB6rGZ/cEPHFo=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.annahri.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.annahri.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.annahri.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.annahri.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.annahri.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=id href=https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://blog.annahri.com/css/custom_papermod.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-CY69EEKCTJ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CY69EEKCTJ")}</script><meta property="og:url" content="https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/"><meta property="og:site_name" content="Linux & Cloud | Blog An-Nahri"><meta property="og:title" content="Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa"><meta property="og:description" content="
Pada artikel ini, saya akan menceritakan bagaimana saya berhasil menyelamankan dan mengembalikan paritisi LVM yang hilang metadatanya karena tertimpa oleh metadata SWAP.
Hal ini terjadi diduga karena sang “user” nampaknya ingin membesar kapasitas RAM dengan menambah ukuran SWAP. Alih-alih membuatnya pada suatu file atau partisi baru, si “user” tersebut membuatnya di partisi dimana root disk berada.
Sejurus kemudian, muncullah permintaan reboot VM yang dimaksud. Tanpa pikir panjang, rekan saya melakukan reboot. Ditunggu beberapa saat kok tidak kunjung UP, diintiplah via console, dan jeng-jeng-jeng, sistem gagal booting dan fallback ke initramfs dengan pesan error bahwa logical volume untuk root partition tidak ditemukan."><meta property="og:locale" content="id-id"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-22T21:59:32+07:00"><meta property="article:modified_time" content="2022-09-22T21:59:32+07:00"><meta property="article:tag" content="LVM"><meta property="og:image" content="https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_testdisk_recovery.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_testdisk_recovery.jpg"><meta name=twitter:title content="Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa"><meta name=twitter:description content="
Pada artikel ini, saya akan menceritakan bagaimana saya berhasil menyelamankan dan mengembalikan paritisi LVM yang hilang metadatanya karena tertimpa oleh metadata SWAP.
Hal ini terjadi diduga karena sang &ldquo;user&rdquo; nampaknya ingin membesar kapasitas RAM dengan menambah ukuran SWAP. Alih-alih membuatnya pada suatu file atau partisi baru, si &ldquo;user&rdquo; tersebut membuatnya di partisi dimana root disk berada.
Sejurus kemudian, muncullah permintaan reboot VM yang dimaksud. Tanpa pikir panjang, rekan saya melakukan reboot. Ditunggu beberapa saat kok tidak kunjung UP, diintiplah via console, dan jeng-jeng-jeng, sistem gagal booting dan fallback ke initramfs dengan pesan error bahwa logical volume untuk root partition tidak ditemukan."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.annahri.com/posts/"},{"@type":"ListItem","position":2,"name":"Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa","item":"https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa","name":"Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa","description":"\nPada artikel ini, saya akan menceritakan bagaimana saya berhasil menyelamankan dan mengembalikan paritisi LVM yang hilang metadatanya karena tertimpa oleh metadata SWAP.\nHal ini terjadi diduga karena sang \u0026ldquo;user\u0026rdquo; nampaknya ingin membesar kapasitas RAM dengan menambah ukuran SWAP. Alih-alih membuatnya pada suatu file atau partisi baru, si \u0026ldquo;user\u0026rdquo; tersebut membuatnya di partisi dimana root disk berada.\nSejurus kemudian, muncullah permintaan reboot VM yang dimaksud. Tanpa pikir panjang, rekan saya melakukan reboot. Ditunggu beberapa saat kok tidak kunjung UP, diintiplah via console, dan jeng-jeng-jeng, sistem gagal booting dan fallback ke initramfs dengan pesan error bahwa logical volume untuk root partition tidak ditemukan.\n","keywords":["LVM"],"articleBody":"\nPada artikel ini, saya akan menceritakan bagaimana saya berhasil menyelamankan dan mengembalikan paritisi LVM yang hilang metadatanya karena tertimpa oleh metadata SWAP.\nHal ini terjadi diduga karena sang “user” nampaknya ingin membesar kapasitas RAM dengan menambah ukuran SWAP. Alih-alih membuatnya pada suatu file atau partisi baru, si “user” tersebut membuatnya di partisi dimana root disk berada.\nSejurus kemudian, muncullah permintaan reboot VM yang dimaksud. Tanpa pikir panjang, rekan saya melakukan reboot. Ditunggu beberapa saat kok tidak kunjung UP, diintiplah via console, dan jeng-jeng-jeng, sistem gagal booting dan fallback ke initramfs dengan pesan error bahwa logical volume untuk root partition tidak ditemukan.\nPemecahan masalah Melihat pesan error yang muncul pada saat booting tersebut, ada inidikasi bahwa root partition telah “rusak” dan sistem tidak mengenalinya lagi atau bahkan tidak menemukannya.\nKemudian, pengecekan menggunakan Live Image ISO Ubuntu 18.04, bisa didapati bahwa susunan layout partisi adalah layout standar jika Ubuntu diinstall menggunakan opsi Guided LVM. yaitu partisi boot terpisah dan sisanya untuk LVM:\nSaat dicek menggunakan blkid, tertulis bahwa sda5 adalah partisi SWAP sedangkan fdisk menunjukkan bahwa sda5 adalah partisi LVM. Dari sini saya berasumsi bahwa yang terjadi adalah sempat ada upaya untuk membuat partisi SWAP namun keliru dan menimpa metadata LVM pada partisi sda5.\nKemudian, saya coba untuk memuat partisi LVM tersebut dengan memindainya menggunakan lvmdiskscan. Dalam situasi normal dan ideal, seharusnya tool tersebut akan memberikan output seperti ini:\n1 2 3 4 5 6 7 8 9 root@host:~# lvmdiskscan | grep -v loop /dev/localhost/root [ 16.27 GiB] /dev/sda1 [ 1.40 GiB] /dev/localhost/swap [ 2.33 GiB] /dev/sda5 [ 23.60 GiB] LVM physical volume 2 disks 4 partitions 0 LVM physical volume whole disks 1 LVM physical volume Dimana partisi LVM akan bisa dideteksi dan diidentifikasi. Jika demikian kondisinya, maka cukup dimuat dengan cara berikut:\n1 2 3 4 # pvscan # vgscan # vgchange -ay # mount ... Namun kondisinya adalah, partisi yang ditengarai sebagai LVM tersebut tidak dikenali oleh sistem sebagai partisi LVM yang valid karena telah rusak metadatanya.\nBermodalkan dengan sedikit kemampuan googling, saya menemukan beberapa artikel yang menunjukkan bagaimana cara memulihkan partisi LVM2 beserta anak-anaknya (PV, VG, LV dan metadatanya). Diantara artikel yang paling membantu adalah ini.\nDi artikel tersebut dijelaskan, yang pada intinya, bahwa hal yang berperan penting dalam pemulihan tersebut adalah file backup metadata LVM, yang secara asal, selalu disimpan di /etc/lvm/backup/\nPertanyaannya, bagaimana cara mendapatkan file tersebut dalam keadaan file itu ada di dalam partisi yang “rusak” dan tidak bisa dimount tersebut?\nIseng-iseng saya coba untuk melakukan less -sr pada partisi yang dimaksud, dan hasilnya, partisi tersebut bisa dilihat bahwa file-file yang ada didalamnya bisa dibaca. Alhamdulillah, sebuah titik terang yang berarti file metadata yang dicari, seharusnya bisa “diambil”.\nBerkenalan dengan sang tool “penyelamat” Kembali menyelami tumpukan jerami google demi mencari sang “jarum”, satu ketemulah satu forum yang sedang membahas permasalahan yang serupa (tapi berbeda). Salah satu jawabannya menjelaskan tentang tool testdisk yang mampu melakukan recovery file pada suatu partisi yang diduga “rusak” atau memang benar-benar rusak.\nSingkat cerita, cukup dengan menjalankan testdisk /dev/sda5, kemudian dilakukan pemindaiaan, dan akhirnya muncul TUI (Text-based User Interface) seperti file explorer yang mana kita bisa eksplorasi file-file di dalam partisi yang sedang diperiksa tersebut, lengkap dengan struktur direktorinya juga! Masya Allah, mantap betul tool ini!\nDengan bantuan tool tersebut, file metadata backup yang dicari-pun berhasil untuk didapatkan!\nPemulihan partisi LVM Pembuatan ulang PV (Physical Volumes) kini bisa dilakukan dengan bermodalkan file backup tadi. Tetapi sebelunya perlu dicatat UUID dari partisi LVM yang hendak dibuat ulang tersebut. Ini bisa didapatkan dengan membuka file backup tadi, kemudian mencocokkannya dengan hasil UUID yang didapatkan via perintah blkid.\nPada bagian bawah tangkapan layar diatas, UUID yang dimaksud ada di bagian:\n1 2 3 4 pv0 { id = UUID \u003c----------------------- DISINI device = /dev/sda5 # Hint Only ... Kemudian, copy UUID tersebut yang nantinya akan digunakan untuk membuat ulang partisi LVM. Perintahnya adalah seperti ini:\n1 pvcreate --restorefile --uuid /dev/sdaX Dapat diperhatikan pada tangkapan layar sebelumnya, terdapat pesan warning yang berbunyi “swap signature detected on /dev/sda5”. Sehingga, memang benar dugaan kuat di awal terkait penyebab rusaknya partisi LVM ini.\nKemudian jika dicek menggunakan pvs atau pvdisplay, maka tentu PV yang dimaksud akan muncul.\nLangkah selanjutnya adalah memulihkan VG (Volume Group) yang ada di dalam PV tersebut. Caranya cukup dengan menjalankan perintah berikut:\n1 vgcfgrestore -f Kemudian aktifkan seluruh LV (Logical Volumes) yang ada di VG tersebut dengan cara:\n1 vgchange -ay Dengan demikian, jika dicek menggunakan lvs atau lsblk, maka akan muncul semua LV yang ada:\nNah, disini muncul permasalahan baru. Kenapa UUID untuk masing-masing LV kok tidak terlihat di output lsblk diatas? Dari sini sempat saya coba untuk mount /dev/localhost/root /mnt tetapi hasilnya gagal dengan error “…wrong fs type…”\nSetelah ditelusuri lebih lanjut, jika melihat pada pesan error yang muncul saat mengaktifkan VG, ada indikasi bahwa partisi /dev/sda5 memiliki ukuran sektor yang lebih kecil daripada ukuran PV. Maka, kemungkinannya adalah, dengan adanya perbedaan ukuran tersebut, tiap-tiap partisi LV, memiliki starting sektor yang tergeser. Sehingga, metadata yang ada didalamnya tidak dikenali oleh sistem, dan UUID tidak muncul sebagaimana mestinya.\nSetelah brainstorming dengan rekan senior saya, diputuskan untuk membuat ulang susunan partisi menggunakan fdisk. Singkatnya, saya hapus partisi 5 (lvm) kemudian partisi 2 (extended), setelah itu buat partisi baru lagi dengan susunan yang sama.\nDan perlu diperhatikan pula, saat membuat ulang partisi ke 5, jangan sampai menghapus LVM2_member signaturenya. Setelah itu, sistem perlu direboot karena partisi LVM tersebut masih “terpakai”.\nKemudian, setelah reboot (setelah mengatur live cd, dst), maka sekarang tiap partisi LV sudah muncul UUIDnya. Nah, disini ketemu dengan permasalahan baru. Partisi /dev/sda5 dan partisi /dev/localhost/swap memiliki UUID yang sama.\nDisini cukup mudah. Tinggal saya buat ulang saja partisi SWAPnya menggunakan mkswap /dev/localhost/swap. Dengan demikian, partisi tersebut akan terlahir kembali dengan UUID baru.\nNah, sekarang pengujian akhir yaitu melakukan uji mounting partisi root dengan mount /dev/localhost/root /mnt, dan hasilnya:\nDisini saya cukup percaya diri bahwa sistem akan berhasil boot, maka langsung reboot saja.\nAlhamdulillah, sistem berhasil dipulihkan!!\nFaidah yang bisa diambil Dari kisah ini, ada beberapa hal penting yang bisa diambil pelajaran:\nBackup data Anda! Seluruh aktivitas diatas terjadi karena tidak adanya backup. Dan perlu untuk ditekankan, bahwa backup seharusnya berada di tempat terpisah dengan objek backup. File penting untuk sistem yang menggunakan filesystem LVM salah satunya adalah file backup metadata yang terletak di /etc/lvm/backup. Jangan lakukan sesuatu yang kita tidak tahu ilmunya, dan yang tidak pada tempatnya. Melakukan sesuatu pada environment production sama seperti berjalan di tepi jurang. Jika ragu, maka serahkan pada yang ahli. Pentingnya skill googling dalam pemecahan masalah. Perlu untuk mengetahui kata kunci yang tepat agar bisa mendapatkan hasil yang juga tepat sasaran. Menurut saya ini adalah skill utama untuk praktisi IT. Sekian artikel kali ini. Semoga memberikan manfaat bagi pembaca, barakallahufiikum.\n","wordCount":"1120","inLanguage":"id","image":"https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_testdisk_recovery.jpg","datePublished":"2022-09-22T21:59:32+07:00","dateModified":"2022-09-22T21:59:32+07:00","author":[{"@type":"Person","name":"Muhammad Ahfas An Nahri"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.annahri.com/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/"},"publisher":{"@type":"Organization","name":"Linux \u0026 Cloud | Blog An-Nahri","logo":{"@type":"ImageObject","url":"https://blog.annahri.com/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.annahri.com/ accesskey=h title="Linux & Cloud | Blog An-Nahri (Alt + H)">Linux & Cloud | Blog An-Nahri</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://blog.annahri.com/about/ title=Tentang><span>Tentang</span></a></li><li><a href=https://blog.annahri.com/arsip/ title=Arsip><span>Arsip</span></a></li><li><a href=https://blog.annahri.com/categories/ title=Kategori><span>Kategori</span></a></li><li><a href=https://blog.annahri.com/tags/ title=Tagar><span>Tagar</span></a></li><li><a href=https://blog.annahri.com/cari/ title=Pencarian><span>Pencarian</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.annahri.com/>Beranda</a>&nbsp;»&nbsp;<a href=https://blog.annahri.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Jurnal: Menyelamatkan Partisi LVM Yang Metadatanya Tertimpa</h1><div class=post-meta><span class=post-date date-time='2022-09-22 21:59:32 +0700 +0700'>22 September 2022</span>&nbsp;·&nbsp;6 menit&nbsp;·&nbsp;Muhammad Ahfas An Nahri&nbsp;|&nbsp;<a href=https://github.com/annahri/blog.annahri.com/tree/main/content/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/index.md rel="noopener noreferrer" target=_blank>Sarankan Pengubahan</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Daftar isi</span></summary><div class=inner><ul><li><a href=#pemecahan-masalah aria-label="Pemecahan masalah">Pemecahan masalah</a></li><li><a href=#berkenalan-dengan-sang-tool-penyelamat aria-label="Berkenalan dengan sang tool &ldquo;penyelamat&rdquo;">Berkenalan dengan sang tool &ldquo;penyelamat&rdquo;</a></li><li><a href=#pemulihan-partisi-lvm aria-label="Pemulihan partisi LVM">Pemulihan partisi LVM</a></li><li><a href=#faidah-yang-bisa-diambil aria-label="Faidah yang bisa diambil">Faidah yang bisa diambil</a></li></ul></div></details></div><div class=post-content><p><img alt=Bismillah loading=lazy src=/images/bismillah-2.png#center></p><p>Pada artikel ini, saya akan menceritakan bagaimana saya berhasil menyelamankan dan mengembalikan paritisi LVM yang hilang metadatanya karena tertimpa oleh metadata SWAP.</p><p>Hal ini terjadi diduga karena sang &ldquo;user&rdquo; nampaknya ingin membesar kapasitas RAM dengan menambah ukuran SWAP. Alih-alih membuatnya pada suatu file atau partisi baru, si &ldquo;user&rdquo; tersebut membuatnya di partisi dimana <em>root disk</em> berada.</p><p>Sejurus kemudian, muncullah permintaan <em>reboot</em> VM yang dimaksud. Tanpa pikir panjang, rekan saya melakukan <em>reboot</em>. Ditunggu beberapa saat kok tidak kunjung <em>UP</em>, diintiplah via console, dan <em>jeng-jeng-jeng</em>, sistem gagal booting dan <em>fallback</em> ke initramfs dengan pesan error bahwa <em>logical volume</em> untuk root partition tidak ditemukan.</p><p><img alt="Gagal boot" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_failboot.jpg#center title="Gagal boot"></p><h2 id=pemecahan-masalah>Pemecahan masalah<a hidden class=anchor aria-hidden=true href=#pemecahan-masalah>#</a></h2><p>Melihat pesan error yang muncul pada saat booting tersebut, ada inidikasi bahwa root partition telah &ldquo;rusak&rdquo; dan sistem tidak mengenalinya lagi atau bahkan tidak menemukannya.</p><p>Kemudian, pengecekan menggunakan <em>Live Image ISO</em> Ubuntu 18.04, bisa didapati bahwa susunan layout partisi adalah layout standar jika Ubuntu diinstall menggunakan opsi <em>Guided LVM</em>. yaitu partisi boot terpisah dan sisanya untuk LVM:</p><p><img alt="Hasil lsblk" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_lsblk.jpg#center title=LSBLK></p><p>Saat dicek menggunakan <code>blkid</code>, tertulis bahwa <code>sda5</code> adalah partisi SWAP sedangkan <code>fdisk</code> menunjukkan bahwa <code>sda5</code> adalah partisi LVM. Dari sini saya berasumsi bahwa yang terjadi adalah sempat ada upaya untuk membuat partisi SWAP namun keliru dan menimpa metadata LVM pada partisi <code>sda5</code>.</p><p><img alt="Hasil blkid" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_hasil-blkid.jpg#center></p><p><img alt="Hasil fstab" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_hasil-fdisk.jpg#center></p><p>Kemudian, saya coba untuk memuat partisi LVM tersebut dengan memindainya menggunakan <code>lvmdiskscan</code>. Dalam situasi normal dan ideal, seharusnya tool tersebut akan memberikan output seperti ini:</p><div class=highlight><div style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>root@host:~# lvmdiskscan  | grep -v loop
</span></span><span style=display:flex><span>  /dev/localhost/root [      16.27 GiB]
</span></span><span style=display:flex><span>  /dev/sda1           [       1.40 GiB]
</span></span><span style=display:flex><span>  /dev/localhost/swap [       2.33 GiB]
</span></span><span style=display:flex><span>  /dev/sda5           [      23.60 GiB] LVM physical volume
</span></span><span style=display:flex><span>  2 disks
</span></span><span style=display:flex><span>  4 partitions
</span></span><span style=display:flex><span>  0 LVM physical volume whole disks
</span></span><span style=display:flex><span>  1 LVM physical volume
</span></span></code></pre></td></tr></table></div></div><p>Dimana partisi LVM akan bisa dideteksi dan diidentifikasi. Jika demikian kondisinya, maka cukup dimuat dengan cara berikut:</p><div class=highlight><div style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># pvscan
</span></span><span style=display:flex><span># vgscan
</span></span><span style=display:flex><span># vgchange -ay
</span></span><span style=display:flex><span># mount ...
</span></span></code></pre></td></tr></table></div></div><p>Namun kondisinya adalah, partisi yang ditengarai sebagai LVM tersebut tidak dikenali oleh sistem sebagai partisi LVM yang valid karena telah rusak metadatanya.</p><p><img alt="LVM tidak dikenal" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_no-lvm.jpg#center></p><p>Bermodalkan dengan sedikit kemampuan <em>googling</em>, saya menemukan beberapa artikel yang menunjukkan bagaimana cara memulihkan partisi LVM2 beserta anak-anaknya (PV, VG, LV dan metadatanya). Diantara artikel yang paling membantu adalah <a href=https://www.golinuxcloud.com/recover-lvm2-partition-restore-vg-pv-metadata/>ini</a>.</p><p>Di artikel tersebut dijelaskan, yang pada intinya, bahwa hal yang berperan penting dalam pemulihan tersebut adalah file <em>backup metadata</em> LVM, yang secara asal, selalu disimpan di <code>/etc/lvm/backup/&lt;nama VG></code></p><p>Pertanyaannya, bagaimana cara mendapatkan file tersebut dalam keadaan file itu ada di dalam partisi yang &ldquo;rusak&rdquo; dan tidak bisa dimount tersebut?</p><p>Iseng-iseng saya coba untuk melakukan <code>less -sr</code> pada partisi yang dimaksud, dan hasilnya, partisi tersebut bisa dilihat bahwa file-file yang ada didalamnya bisa dibaca. Alhamdulillah, sebuah titik terang yang berarti file metadata yang dicari, seharusnya bisa &ldquo;diambil&rdquo;.</p><h2 id=berkenalan-dengan-sang-tool-penyelamat>Berkenalan dengan sang tool &ldquo;penyelamat&rdquo;<a hidden class=anchor aria-hidden=true href=#berkenalan-dengan-sang-tool-penyelamat>#</a></h2><p>Kembali menyelami tumpukan jerami google demi mencari sang &ldquo;jarum&rdquo;, satu ketemulah satu forum yang sedang membahas permasalahan yang serupa (tapi berbeda). Salah satu jawabannya menjelaskan tentang tool <code>testdisk</code> yang mampu melakukan recovery file pada suatu partisi yang diduga &ldquo;rusak&rdquo; atau memang benar-benar rusak.</p><p><img alt=testdisk loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_testdisk_select.jpg#center></p><p>Singkat cerita, cukup dengan menjalankan <code>testdisk /dev/sda5</code>, kemudian dilakukan pemindaiaan, dan akhirnya muncul TUI (<em>Text-based User Interface</em>) seperti file explorer yang mana kita bisa eksplorasi file-file di dalam partisi yang sedang diperiksa tersebut, lengkap dengan struktur direktorinya juga! <em>Masya Allah</em>, mantap betul tool ini!</p><p><img alt="file backup didapatkan" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_testdisk_recovery.jpg#center></p><p>Dengan bantuan tool tersebut, file metadata backup yang dicari-pun berhasil untuk didapatkan!</p><h2 id=pemulihan-partisi-lvm>Pemulihan partisi LVM<a hidden class=anchor aria-hidden=true href=#pemulihan-partisi-lvm>#</a></h2><p>Pembuatan ulang PV (<em>Physical Volumes</em>) kini bisa dilakukan dengan bermodalkan file backup tadi. Tetapi sebelunya perlu dicatat UUID dari partisi LVM yang hendak dibuat ulang tersebut. Ini bisa didapatkan dengan membuka file backup tadi, kemudian mencocokkannya dengan hasil UUID yang didapatkan via perintah <code>blkid</code>.</p><p><img alt="file metadata backup" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_metadata-backup.jpg#center title="Isi file metadata backup"></p><p>Pada bagian bawah tangkapan layar diatas, UUID yang dimaksud ada di bagian:</p><div class=highlight><div style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pv0 {
</span></span><span style=display:flex><span>    id = UUID &lt;----------------------- DISINI
</span></span><span style=display:flex><span>    device = /dev/sda5 # Hint Only
</span></span><span style=display:flex><span>...
</span></span></code></pre></td></tr></table></div></div><p>Kemudian, copy UUID tersebut yang nantinya akan digunakan untuk membuat ulang partisi LVM. Perintahnya adalah seperti ini:</p><p><a href=./lvm_pv-recreate.jpg><img alt=pvcreate loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_pv-recreate.jpg#center title="Perintah untuk membuat ulang suatu PV dengan backup metadata."></a></p><div class=highlight><div style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pvcreate --restorefile &lt;file backup&gt; --uuid &lt;uuid&gt; /dev/sdaX
</span></span></code></pre></td></tr></table></div></div><p>Dapat diperhatikan pada tangkapan layar sebelumnya, terdapat pesan <em>warning</em> yang berbunyi &ldquo;<em>swap signature detected on /dev/sda5</em>&rdquo;. Sehingga, memang benar dugaan kuat di awal terkait penyebab rusaknya partisi LVM ini.</p><p>Kemudian jika dicek menggunakan <code>pvs</code> atau <code>pvdisplay</code>, maka tentu PV yang dimaksud akan muncul.</p><p><img alt="PV muncul" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_pv-muncul.jpg#center title="PV sudah dikenali oleh sistem."></p><p>Langkah selanjutnya adalah memulihkan VG (<em>Volume Group</em>) yang ada di dalam PV tersebut. Caranya cukup dengan menjalankan perintah berikut:</p><div class=highlight><div style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>vgcfgrestore -f &lt;file backup&gt; &lt;nama VG&gt;
</span></span></code></pre></td></tr></table></div></div><p><img alt="Pemulihan VG" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_restore-vg.jpg#center></p><p>Kemudian aktifkan seluruh LV (<em>Logical Volumes</em>) yang ada di VG tersebut dengan cara:</p><div class=highlight><div style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>vgchange -ay
</span></span></code></pre></td></tr></table></div></div><p>Dengan demikian, jika dicek menggunakan <code>lvs</code> atau <code>lsblk</code>, maka akan muncul semua LV yang ada:</p><p><img alt=LV loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_uuid-belum-muncul.jpg#center></p><p>Nah, disini muncul permasalahan baru. Kenapa UUID untuk masing-masing LV kok tidak terlihat di output <code>lsblk</code> diatas? Dari sini sempat saya coba untuk <code>mount /dev/localhost/root /mnt</code> tetapi hasilnya gagal dengan error &ldquo;&mldr;wrong fs type&mldr;&rdquo;</p><p>Setelah ditelusuri lebih lanjut, jika melihat pada pesan error yang muncul saat mengaktifkan VG, ada indikasi bahwa partisi <code>/dev/sda5</code> memiliki ukuran sektor yang lebih kecil daripada ukuran PV. Maka, kemungkinannya adalah, dengan adanya perbedaan ukuran tersebut, tiap-tiap partisi LV, memiliki <em>starting</em> sektor yang tergeser. Sehingga, metadata yang ada didalamnya tidak dikenali oleh sistem, dan UUID tidak muncul sebagaimana mestinya.</p><p>Setelah brainstorming dengan rekan senior saya, diputuskan untuk membuat ulang susunan partisi menggunakan <code>fdisk</code>. Singkatnya, saya hapus partisi 5 (lvm) kemudian partisi 2 (extended), setelah itu buat partisi baru lagi dengan susunan yang sama.</p><p><img alt="Membuat ulang tabel partisi" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_recreate-partition-table.jpg#center></p><p>Dan perlu diperhatikan pula, saat membuat ulang partisi ke 5, jangan sampai menghapus <strong>LVM2_member</strong> signaturenya. Setelah itu, sistem perlu direboot karena partisi LVM tersebut masih &ldquo;terpakai&rdquo;.</p><p>Kemudian, setelah reboot (setelah mengatur live cd, dst), maka sekarang tiap partisi LV sudah muncul UUIDnya. Nah, disini ketemu dengan permasalahan baru. Partisi <code>/dev/sda5</code> dan partisi <code>/dev/localhost/swap</code> memiliki UUID yang sama.</p><p><img alt="UUID muncul" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_uuid-kembar.jpg#center></p><p>Disini cukup mudah. Tinggal saya buat ulang saja partisi SWAPnya menggunakan <code>mkswap /dev/localhost/swap</code>. Dengan demikian, partisi tersebut akan terlahir kembali dengan UUID baru.</p><p><img alt="UUID baru" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/recreate-swap.jpg#center></p><p>Nah, sekarang pengujian akhir yaitu melakukan uji <em>mounting</em> partisi root dengan <code>mount /dev/localhost/root /mnt</code>, dan hasilnya:</p><p><img alt="Mount root" loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/lvm_mounted.jpg#center></p><p>Disini saya cukup percaya diri bahwa sistem akan berhasil boot, maka langsung reboot saja.</p><p><img alt=Booted loading=lazy src=/posts/jurnal-menyelamatkan-partisi-lvm-yang-rusak/sistem-pulih.jpg></p><p><em>Alhamdulillah</em>, sistem berhasil dipulihkan!!</p><h2 id=faidah-yang-bisa-diambil>Faidah yang bisa diambil<a hidden class=anchor aria-hidden=true href=#faidah-yang-bisa-diambil>#</a></h2><p>Dari kisah ini, ada beberapa hal penting yang bisa diambil pelajaran:</p><ol><li>Backup data Anda! Seluruh aktivitas diatas terjadi karena tidak adanya backup. Dan perlu untuk ditekankan, bahwa backup seharusnya berada di tempat terpisah dengan objek backup.</li><li>File penting untuk sistem yang menggunakan <em>filesystem</em> LVM salah satunya adalah file backup metadata yang terletak di <code>/etc/lvm/backup</code>.</li><li>Jangan lakukan sesuatu yang kita tidak tahu ilmunya, dan yang tidak pada tempatnya. Melakukan sesuatu pada <em>environment</em> <em>production</em> sama seperti berjalan di tepi jurang. Jika ragu, maka serahkan pada yang ahli.</li><li>Pentingnya skill <em>googling</em> dalam pemecahan masalah. Perlu untuk mengetahui kata kunci yang tepat agar bisa mendapatkan hasil yang juga tepat sasaran. Menurut saya ini adalah skill utama untuk praktisi IT.</li></ol><hr><p>Sekian artikel kali ini. Semoga memberikan manfaat bagi pembaca, <em>barakallahufiikum</em>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.annahri.com/tags/lvm/>LVM</a></li></ul><nav class=paginav><a class=prev href=https://blog.annahri.com/posts/belajar-bash-scripting-signal-trapping/><span class=title>« Sebelumnya</span><br><span>Belajar Bash Scripting: Signal Trapping</span>
</a><a class=next href=https://blog.annahri.com/posts/belajar-bash-scripting-argument-parsing/><span class=title>Selanjutnya »</span><br><span>Belajar Bash Scripting: Argument Parsing</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=annahri/blog.annahri.com data-repo-id=R_kgDOGUC4_g data-category=General data-category-id=DIC_kwDOGUC4_s4CdOMx data-mapping=og:title data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=dark_dimmed data-lang=id data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.annahri.com/>Linux & Cloud | Blog An-Nahri</a></span> ·
Semua hak cipta dilindungi. Konten di blog ini tidak dapat digunakan, disalin, atau didistribusikan tanpa izin tertulis dari pemilik hak cipta ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="salin";function s(){t.innerHTML="disalin!",setTimeout(()=>{t.innerHTML="salin"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>